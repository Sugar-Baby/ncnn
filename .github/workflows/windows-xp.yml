name: windows-xp
on:
  push:
    branches: [master]
    paths:
    - '.github/workflows/windows-xp.yml'
    - 'toolchains/windows-xp.toolchain.cmake'
    - 'CMakeLists.txt'
    - 'cmake/**'
    - 'src/*'
    - 'src/layer/*'
    - 'src/layer/x86/**'
    - 'tests/**'
    - 'tools/**'
    - '!tools/pnnx/**'
    - 'examples/**'
    - 'benchmark/**'
  pull_request:
    branches: [master]
    paths:
    - '.github/workflows/windows-xp.yml'
    - 'toolchains/windows-xp.toolchain.cmake'
    - 'CMakeLists.txt'
    - 'cmake/**'
    - 'src/*'
    - 'src/layer/*'
    - 'src/layer/x86/**'
    - 'tests/**'
    - 'tools/**'
    - '!tools/pnnx/**'
    - 'examples/**'
    - 'benchmark/**'
concurrency:
  group: windows-xp-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read

jobs:
  windows-xp:
    name: Windows XP Compatibility
    runs-on: windows-2022

    env:
      UseMultiToolTask: true

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: x86 MinGW (Windows XP compatible)
      run: |
        mkdir build-xp-mingw
        cd build-xp-mingw
        
        cmake -DCMAKE_TOOLCHAIN_FILE=../toolchains/windows-xp.toolchain.cmake -DNCNN_VULKAN=OFF -DNCNN_SIMPLEOCV=ON -DNCNN_BUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Release -G "MinGW Makefiles" ..
        
        cmake --build . --config Release -j 2

    - name: x86 MinGW test (Windows XP compatible)
      run: |
        cd build-xp-mingw
        ctest -C Release --output-on-failure -j 2

    - name: x86 MSVC (Windows XP compatible)
      run: |
        mkdir build-xp-msvc
        cd build-xp-msvc
        
        cmake -DCMAKE_TOOLCHAIN_FILE=../toolchains/windows-xp-msvc.toolchain.cmake -DNCNN_VULKAN=OFF -DNCNN_SIMPLEOCV=ON -DNCNN_BUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Release ..
        
        cmake --build . --config Release -j 2

    - name: x86 MSVC test (Windows XP compatible)
      run: |
        cd build-xp-msvc
        ctest -C Release --output-on-failure -j 2

    - name: Verify XP Compatibility (MinGW)
      run: |
        cd build-xp-mingw
        
        Write-Host "Checking test executables..."
        Get-ChildItem -Path "tests" -Filter "*.exe" -Recurse | ForEach-Object {
          Write-Host "✓ Found test executable: $($_.Name)"
        }
        
        Write-Host "Checking library files..."
        Get-ChildItem -Path "src" -Filter "*.dll" -Recurse | ForEach-Object {
          Write-Host "✓ Found library: $($_.Name)"
        }
        
        Write-Host "Checking static libraries..."
        Get-ChildItem -Path "src" -Filter "*.a" -Recurse | ForEach-Object {
          Write-Host "✓ Found static library: $($_.Name)"
        }

    - name: Verify XP Compatibility (MSVC)
      run: |
        cd build-xp-msvc
        
        Write-Host "Checking test executables..."
        Get-ChildItem -Path "tests" -Filter "*.exe" -Recurse | ForEach-Object {
          Write-Host "✓ Found test executable: $($_.Name)"
        }
        
        Write-Host "Checking library files..."
        Get-ChildItem -Path "src" -Filter "*.dll" -Recurse | ForEach-Object {
          Write-Host "✓ Found library: $($_.Name)"
        }
        
        Write-Host "Checking static libraries..."
        Get-ChildItem -Path "src" -Filter "*.lib" -Recurse | ForEach-Object {
          Write-Host "✓ Found static library: $($_.Name)"
        }